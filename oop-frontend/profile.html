<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mobile-screen">
        
        <header class="header">
            <span class="header-title">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
            <a href="profile.html" class="profile-icon"></a>
        </header>
        
        <div class="content">
            <h2 class="page-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>

            <div class="form-group">
                <label for="edit-weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</label>
                <input type="text" id="edit-weight">
            </div>
            
            <div class="form-group">
                <label for="edit-height">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm)</label>
                <input type="text" id="edit-height">
            </div>

            <button id="recalcBtn" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</button>
            
            <div class="bmi-result-box" id="profile-bmi-box">
                <strong>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</strong> <span id="profile-weight">--</span> kg
                <br>
                <strong>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á:</strong> <span id="profile-height">--</span> cm
                <br><br>
                <strong>‡∏Ñ‡πà‡∏≤ BMI:</strong> <span id="profile-bmi">--.-</span>
                <br>
                <small>(‡∏Ñ‡∏ß‡∏£‡∏Å‡∏¥‡∏ô <span id="profile-calories">----</span> ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà)</small>
            </div>
            
            <table class="bmi-table">
                <thead>
                    <tr>
                        <th>‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á</th>
                        <th>‡∏Ñ‡πà‡∏≤ BMI</th>
                    </tr>
                </thead>
                <tbody id="bmi-table-body">
                    <tr>
                        <td>...</td>
                        <td>...</td>
                    </tr>
                </tbody>
            </table>

            <a href="login.html" class="btn btn-secondary-link" style="margin-top: 20px;" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
        <footer class="footer-nav">
            <a href="home.html" class="footer-icon">‚¨ÖÔ∏è</a>
            <a href="cart.html" class="footer-icon">üõí</a>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 1. ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const username = localStorage.getItem('currentUser');
            if (!username) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà login ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
                window.location.href = 'login.html';
                return;
            }

            // 2. ‡∏î‡∏∂‡∏á Element ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
            const editWeight = document.getElementById('edit-weight');
            const editHeight = document.getElementById('edit-height');
            const recalcBtn = document.getElementById('recalcBtn');
            const profileWeight = document.getElementById('profile-weight');
            const profileHeight = document.getElementById('profile-height');
            const profileBmi = document.getElementById('profile-bmi');
            const profileCalories = document.getElementById('profile-calories');
            const bmiTableBody = document.getElementById('bmi-table-body');
            const logoutBtn = document.getElementById('logoutBtn');

            // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            loadProfileData();

            // 4. ‡∏ú‡∏π‡∏Å Event ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
            recalcBtn.addEventListener('click', function() {
                const newWeight = parseFloat(editWeight.value);
                const newHeight = parseFloat(editHeight.value);

                if (newWeight > 0 && newHeight > 0) {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì BMI
                    fetch('http://localhost:8080/api/bmi/calculate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: username,
                            weight: newWeight,
                            height: newHeight
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                            updateProfileDisplay({
                                weight: newWeight,
                                height: newHeight,
                                bmi: data.bmi,
                                calories: data.calories,
                                category: data.category,
                                categoryRange: data.categoryRange
                            });
                            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!');
                        } else {
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ'));
                        }
                    })
                    .catch(error => {
                        console.error('Error calculating BMI:', error);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö server ‡πÑ‡∏î‡πâ');
                    });
                } else {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            });

            // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á
            function loadUserData() {
                fetch(`http://localhost:8080/api/bmi/data/${username}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô input fields
                            editWeight.value = data.weight;
                            editHeight.value = data.height;
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                            profileWeight.textContent = data.weight;
                            profileHeight.textContent = data.height;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading user data:', error);
                        // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    });
            }

            // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI ‡∏à‡∏≤‡∏Å API
            function loadProfileData() {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏Å‡πà‡∏≠‡∏ô
                loadUserData();
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI
                fetch(`http://localhost:8080/api/bmi/${username}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                            const weight = parseFloat(editWeight.value) || 0;
                            const height = parseFloat(editHeight.value) || 0;
                            updateProfileDisplay({
                                weight: weight,
                                height: height,
                                bmi: data.bmi,
                                calories: data.calories,
                                category: data.category,
                                categoryRange: data.categoryRange
                            });
                        } else {
                            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            document.getElementById('profile-bmi-box').innerHTML = 
                                '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI <br> <small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</small>';
                            bmiTableBody.innerHTML = '<tr><td>-</td><td>-</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading BMI:', error);
                        document.getElementById('profile-bmi-box').innerHTML = 
                            '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI <br> <small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</small>';
                        bmiTableBody.innerHTML = '<tr><td>-</td><td>-</td></tr>';
                    });
            }

            // 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å, ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á, BMI, ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ, ‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
            function updateProfileDisplay(data) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á
                if (data.weight) {
                    profileWeight.textContent = data.weight;
                }
                if (data.height) {
                    profileHeight.textContent = data.height;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á BMI ‡πÅ‡∏•‡∏∞‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà
                profileBmi.textContent = data.bmi;
                profileCalories.textContent = data.calories;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API)
                bmiTableBody.innerHTML = `<tr><td>${data.category}</td><td>${data.categoryRange}</td></tr>`;
            }

            // 8. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentUserRole');
                localStorage.removeItem('cart'); 
            });
        });
    </script>
</body>
</html>