<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="mobile-screen">
        
        <header class="header">
            <span class="header-title">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            <a href="profile.html" class="profile-icon"></a>
        </header>
        
        <div class="content">
            <div class="search-bar-container">
                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" id="searchInput">
                <button class="search-btn">
                    <i class="fas fa-search"></i> </button>
            </div>

            <div id="menu-container">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                <p style="text-align: center; margin-top: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£...</p>
            </div>

            </div>
        
        <footer class="footer-nav" style="justify-content: flex-end;">
            <a href="cart.html" class="footer-icon">üõí</a>
        </footer>

    </div>

    <div id="foodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                <span class="close-btn" id="closeBtn">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById("foodModal");
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");
            const closeBtn = document.getElementById("closeBtn");
            const menuContainer = document.getElementById("menu-container");
            const searchInput = document.getElementById("searchInput");

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ login ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const username = localStorage.getItem('currentUser');
            if (!username) {
                window.location.href = 'login.html';
                return;
            }

            // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å API
            loadFoods();

            // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å API
            function loadFoods() {
                fetch('http://localhost:8080/api/foods')
                    .then(response => response.json())
                    .then(foods => {
                        displayFoods(foods);
                    })
                    .catch(error => {
                        console.error('Error loading foods:', error);
                        menuContainer.innerHTML = '<p style="text-align: center; color: red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ (Backend ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà?)</p>';
                    });
            }

            // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            function displayFoods(foods) {
                menuContainer.innerHTML = '';
                foods.forEach(food => {
                    const menuItemDiv = document.createElement('div');
                    menuItemDiv.className = 'menu-item';
                    menuItemDiv.dataset.name = food.name;
                    menuItemDiv.dataset.kcal = food.kcal;
                    menuItemDiv.dataset.fat = food.fat;
                    menuItemDiv.dataset.sugar = food.sugar;
                    menuItemDiv.dataset.sodium = food.sodium;
                    
                    menuItemDiv.innerHTML = `
                        <div class="item-image-placeholder"></div>
                        <div class="item-text">
                            <strong>${food.name}</strong>
                            <span>‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <button class="add-btn">+</button>
                    `;
                    
                    menuContainer.appendChild(menuItemDiv);
                });

                // ‡∏ú‡∏π‡∏Å Event listeners ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏•‡πâ‡∏ß
                attachEventListeners();
            }

            // 4. ‡∏ú‡∏π‡∏Å Event Listeners
            function attachEventListeners() {
                const menuItems = document.querySelectorAll(".menu-item");
                const addButtons = document.querySelectorAll(".add-btn");

                menuItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('add-btn')) {
                            openModal(item);
                        }
                    });
                });

                addButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const item = button.closest('.menu-item');
                        addToCart(item);
                    });
                });
            }

            // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal
            function openModal(item) {
                const name = item.dataset.name;
                const kcal = item.dataset.kcal;
                const fat = item.dataset.fat;
                const sugar = item.dataset.sugar;
                const sodium = item.dataset.sodium;

                modalTitle.textContent = name;
                modalBody.innerHTML = `
                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π:</strong> ${name}</p>
                    <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong></p>
                    <ul>
                        <li>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô: ${kcal} kcal</li>
                        <li>‡πÑ‡∏Ç‡∏°‡∏±‡∏ô: ${fat}g</li>
                        <li>‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•: ${sugar}g</li>
                        <li>‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°: ${sodium}mg</li>
                    </ul>
                `;
                modal.style.display = "flex";
            }

            // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
            function closeModal() {
                modal.style.display = "none";
            }
            
            closeBtn.onclick = closeModal;
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô API
            function addToCart(item) {
                const foodName = item.dataset.name;
                const username = localStorage.getItem('currentUser');

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ username ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!username) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
                    window.location.href = 'login.html';
                    return;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ foodName ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!foodName) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
                    return;
                }

                const requestBody = {
                    username: username,
                    foodName: foodName
                };

                console.log('Sending request:', requestBody); // Debug log

                fetch('http://localhost:8080/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || 'HTTP error! status: ' + response.status);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${foodName}" ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!`);
                    } else {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÑ‡∏î‡πâ'));
                    }
                })
                .catch(error => {
                    console.error('Error adding to cart:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                });
            }
        });
    </script>
</body>
</html>