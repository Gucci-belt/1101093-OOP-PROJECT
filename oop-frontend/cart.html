<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mobile-screen">
        
        <header class="header">
            <span class="header-title">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
            <a href="profile.html" class="profile-icon"></a>
        </header>
        
        <div class="content" id="cart-container">
            
            <a href="summary.html" class="btn" style="margin-top: 30px;" id="summaryBtn">‡∏£‡∏ß‡∏°</a>
        </div>
        
        <footer class="footer-nav">
            <a href="home.html" class="footer-icon">üè†</a>
            <a href="health-dashboard.html" class="footer-icon">üìä</a>
            <a href="cart.html" class="footer-icon">üõí</a>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cartContainer = document.getElementById('cart-container');
            const summaryBtn = document.getElementById('summaryBtn');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ login ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const username = localStorage.getItem('currentUser');
            if (!username) {
                window.location.href = 'login.html';
                return;
            }
            
            loadCart(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤

            // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏≤‡∏Å API
            function loadCart() {
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏ß‡∏°")
                cartContainer.querySelectorAll('.menu-item').forEach(item => item.remove());
                cartContainer.querySelectorAll('.empty-msg').forEach(item => item.remove());

                fetch(`http://localhost:8080/api/cart/${username}`)
                    .then(response => response.json())
                    .then(cart => {
                        if (cart.length === 0) {
                            // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
                            const emptyMsg = document.createElement('p');
                            emptyMsg.textContent = '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤';
                            emptyMsg.className = 'empty-msg';
                            emptyMsg.style.textAlign = 'center';
                            emptyMsg.style.marginTop = '30px';
                            cartContainer.insertBefore(emptyMsg, summaryBtn);
                        } else {
                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            cart.forEach((item, index) => {
                                const menuItemDiv = document.createElement('div');
                                menuItemDiv.className = 'menu-item';
                                
                                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î path ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ placeholder)
                                const imagePath = `images/${item.name.toLowerCase().replace(/\s+/g, '-')}.jpg`;
                                
                                menuItemDiv.innerHTML = `
                                    <img src="${imagePath}" alt="${item.name}" class="item-image" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="item-image-placeholder" style="display: none;"></div>
                                    <div class="item-text">
                                        <strong>${item.name}</strong>
                                        <span>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô: ${item.kcal} kcal, ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô: ${item.fat}g</span>
                                    </div>
                                    <button class="remove-btn" data-food-name="${item.name}">&times;</button>
                                `;
                                
                                cartContainer.insertBefore(menuItemDiv, summaryBtn);
                            });

                            // ‡∏ú‡∏π‡∏Å Event ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
                            addRemoveListeners();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading cart:', error);
                        const errorMsg = document.createElement('p');
                        errorMsg.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÑ‡∏î‡πâ (Backend ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà?)';
                        errorMsg.style.textAlign = 'center';
                        errorMsg.style.color = 'red';
                        errorMsg.style.marginTop = '30px';
                        cartContainer.insertBefore(errorMsg, summaryBtn);
                    });
            }

            // 2. ‡∏ú‡∏π‡∏Å Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
            function addRemoveListeners() {
                document.querySelectorAll('.remove-btn').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const foodName = e.target.dataset.foodName;
                        removeItemFromCart(foodName);
                    });
                });
            }

            // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô API
            function removeItemFromCart(foodName) {
                const username = localStorage.getItem('currentUser');

                fetch('http://localhost:8080/api/cart/remove', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        foodName: foodName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadCart(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤
                        // Trigger cart update event
                        const updateEvent = new Event('cartUpdated');
                        window.dispatchEvent(updateEvent);
                        // Also update localStorage to trigger storage event
                        localStorage.setItem(`cart_updated_${username}_${Date.now()}`, 'true');
                    } else {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ'));
                    }
                })
                .catch(error => {
                    console.error('Error removing from cart:', error);
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (Backend ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà?)');
                });
            }
        });
    </script>
</body>
</html>